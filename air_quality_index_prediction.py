# -*- coding: utf-8 -*-
"""air-quality-index-prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1B5bKNT-oqXJMzeiepmKL5XhnkaogQ4yT
"""

!pip install opendatasets shap lightgbm xgboost prophet

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score

from sklearn.linear_model import LinearRegression
from sklearn.ensemble import RandomForestRegressor
from sklearn.svm import SVR
from xgboost import XGBRegressor
from lightgbm import LGBMRegressor

import shap

import opendatasets as od

od.download("https://www.kaggle.com/datasets/rohanrao/air-quality-data-in-india")

df = pd.read_csv(
    "/content/air-quality-data-in-india/city_day.csv"
)
df.head()

df.info()

df.isnull().sum()

plt.figure(figsize=(6,4))
sns.histplot(df['AQI'], kde=True)
plt.title("AQI Distribution")
plt.show()

features = [
    'PM2.5', 'PM10', 'NO', 'NO2', 'NOx',
    'NH3', 'CO', 'SO2', 'O3'
]

df = df[features + ['AQI']]

df.fillna(df.median(), inplace=True)

X = df.drop('AQI', axis=1)
y = df['AQI']

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

scaler = StandardScaler()

X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

lr = LinearRegression()
lr.fit(X_train_scaled, y_train)

y_pred_lr = lr.predict(X_test_scaled)

rf = RandomForestRegressor(
    n_estimators=100,
    random_state=42
)
rf.fit(X_train, y_train)

y_pred_rf = rf.predict(X_test)

xgb = XGBRegressor(
    n_estimators=100,
    learning_rate=0.1,
    random_state=42
)
xgb.fit(X_train, y_train)

y_pred_xgb = xgb.predict(X_test)

svr = SVR(kernel='rbf')
svr.fit(X_train_scaled, y_train)

y_pred_svr = svr.predict(X_test_scaled)

def evaluate_model(name, y_test, y_pred):
    print(f"\n{name}")
    print("MAE:", mean_absolute_error(y_test, y_pred))
    print("RMSE:", np.sqrt(mean_squared_error(y_test, y_pred)))
    print("R2 Score:", r2_score(y_test, y_pred))

evaluate_model("Linear Regression", y_test, y_pred_lr)
evaluate_model("Random Forest", y_test, y_pred_rf)
evaluate_model("XGBoost", y_test, y_pred_xgb)
evaluate_model("SVR", y_test, y_pred_svr)

importances = rf.feature_importances_

plt.figure(figsize=(8,5))
sns.barplot(x=importances, y=X.columns)
plt.title("Feature Importance (Random Forest)")
plt.show()

# --------------------------
# explainer = shap.Explainer(rf, X_train)
# shap_values = explainer(X_test)

# shap.summary_plot(shap_values, X_test)
# ----------------------------------
# explainer = shap.TreeExplainer(rf)

# shap_values = explainer.shap_values(
#     X_test,
#     check_additivity=False
# )

# shap.summary_plot(shap_values, X_test)

# -------------------------------
X_shap = X_test.sample(500, random_state=42)

explainer = shap.TreeExplainer(rf)

shap_values = explainer.shap_values(
    X_shap,
    check_additivity=False
)

shap.summary_plot(shap_values, X_shap)

# explainer = shap.Explainer(rf, X_train)
# shap_values = explainer(X_test)

# shap.summary_plot(shap_values, X_test)

import shap

# Use a smaller sample to speed things up
X_shap = X_test.sample(500, random_state=42)

# Explicit TreeExplainer
explainer = shap.TreeExplainer(rf)

# Disable additivity check (EXPECTED for RF)
shap_values = explainer.shap_values(
    X_shap,
    check_additivity=False
)

# Plot
shap.summary_plot(shap_values, X_shap)

df_ts = pd.read_csv(
    "/content/air-quality-data-in-india/city_day.csv"
)

df_ts['Date'] = pd.to_datetime(df_ts['Date'])
df_ts = df_ts[['Date', 'AQI']].dropna()

df_ts = df_ts.groupby('Date').mean().reset_index()

plt.figure(figsize=(12,4))
plt.plot(df_ts['Date'], df_ts['AQI'])
plt.title("AQI Trend Over Time")
plt.show()

from prophet import Prophet

prophet_df = df_ts.rename(columns={'Date':'ds', 'AQI':'y'})

model = Prophet()
model.fit(prophet_df)

future = model.make_future_dataframe(periods=365)
forecast = model.predict(future)

model.plot(forecast)